<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‚öîÔ∏è IdleDuelist - Full Game ‚öîÔ∏è</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            color: #fff;
            min-height: 100vh;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        h1 {
            text-align: center;
            margin-bottom: 30px;
            font-size: 2.5em;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
        }

        .game-section {
            display: none;
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 30px;
            margin-bottom: 20px;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .game-section.active {
            display: block;
        }

        .form-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
            color: #e0e0e0;
        }

        input, select {
            width: 100%;
            padding: 12px;
            border: none;
            border-radius: 8px;
            background: rgba(255, 255, 255, 0.9);
            color: #333;
            font-size: 16px;
        }

        button {
            background: linear-gradient(45deg, #ff6b6b, #ee5a24);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
            transition: all 0.3s ease;
            margin: 5px;
        }

        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }

        .stat-card {
            background: rgba(255, 255, 255, 0.1);
            padding: 15px;
            border-radius: 10px;
            text-align: center;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .stat-value {
            font-size: 1.5em;
            font-weight: bold;
            color: #ffd700;
        }

        .combat-log {
            background: rgba(0, 0, 0, 0.7);
            border-radius: 10px;
            padding: 20px;
            margin: 20px 0;
            max-height: 400px;
            overflow-y: auto;
            font-family: 'Courier New', monospace;
            border: 2px solid #444;
        }

        .combat-log p {
            margin: 5px 0;
            padding: 5px;
            border-radius: 3px;
        }

        .ability-used { background: rgba(138, 43, 226, 0.3); }
        .damage-dealt { background: rgba(220, 20, 60, 0.3); }
        .healing { background: rgba(0, 255, 127, 0.3); }
        .dodge { background: rgba(255, 165, 0, 0.3); }
        .crit { background: rgba(255, 215, 0, 0.3); }
        .victory { background: rgba(0, 255, 0, 0.3); font-weight: bold; font-size: 1.2em; }
        .defeat { background: rgba(255, 0, 0, 0.3); font-weight: bold; font-size: 1.2em; }
        .round-header { background: rgba(70, 130, 180, 0.4); font-weight: bold; font-size: 1.1em; text-align: center; }
        .turn-header { background: rgba(100, 149, 237, 0.3); font-weight: bold; }

        .leaderboard {
            background: rgba(0, 0, 0, 0.5);
            border-radius: 10px;
            padding: 20px;
        }

        .leaderboard-item {
            display: flex;
            justify-content: space-between;
            padding: 10px;
            margin: 5px 0;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 5px;
        }

        .loadout-section {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 10px;
            padding: 20px;
            margin: 20px 0;
            border: 2px solid rgba(255, 255, 255, 0.1);
        }

        .loadout-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }

        .loadout-card {
            background: rgba(255, 255, 255, 0.1);
            padding: 15px;
            border-radius: 10px;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .bonus-info {
            background: rgba(0, 255, 0, 0.1);
            border: 1px solid rgba(0, 255, 0, 0.3);
            border-radius: 8px;
            padding: 10px;
            margin: 10px 0;
            font-size: 0.9em;
        }

        .nav-buttons {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin: 20px 0;
            flex-wrap: wrap;
        }

        .current-player {
            background: rgba(0, 255, 0, 0.2);
            border: 2px solid rgba(0, 255, 0, 0.5);
            border-radius: 10px;
            padding: 15px;
            margin: 20px 0;
        }

        .logout-btn {
            background: linear-gradient(45deg, #e74c3c, #c0392b);
            float: right;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>‚öîÔ∏è IdleDuelist - Full Game ‚öîÔ∏è</h1>
        
        <!-- Login Section -->
        <div id="login-section" class="game-section active">
            <div class="current-player" id="current-player-info" style="display: none;">
                <h3>Currently Playing As: <span id="current-username"></span></h3>
                <button class="logout-btn" onclick="logout()">Logout</button>
            </div>
            
            <form id="login-form">
                <div class="form-group">
                    <label for="login-username">Username:</label>
                    <input type="text" id="login-username" name="username" required>
                </div>
                <div class="form-group">
                    <label for="login-password">Password:</label>
                    <input type="password" id="login-password" name="password" required>
                </div>
                <button type="submit">Login</button>
                <button type="button" onclick="showCharacterCreation()">Create New Character</button>
            </form>
        </div>

        <!-- Character Creation Section -->
        <div id="character-creation" class="game-section">
            <h2>Create New Character</h2>
            <form id="character-form">
                <div class="form-group">
                    <label for="username">Character Name:</label>
                    <input type="text" id="username" name="username" required>
                </div>
                
                <div class="form-group">
                    <label for="password">Password:</label>
                    <input type="password" id="password" name="password" required minlength="6">
                    <small>Password must be at least 6 characters long</small>
                </div>
                
                <div class="form-group">
                    <label for="confirm-password">Confirm Password:</label>
                    <input type="password" id="confirm-password" name="confirm_password" required>
                </div>
                
                <div class="form-group">
                    <label for="faction">Faction:</label>
                    <select id="faction" name="faction" onchange="updateAbilities()" required>
                        <option value="">Select Faction</option>
                        <option value="order_of_the_silver_crusade">Order of the Silver Crusade</option>
                        <option value="shadow_covenant">Shadow Covenant</option>
                        <option value="wilderness_tribe">Wilderness Tribe</option>
                    </select>
                </div>

                <div class="form-group">
                    <label>Starting Equipment:</label>
                    <p class="equipment-info">You'll start with a full cloth armor set, sword, and shield. You can customize your loadout after character creation!</p>
                </div>

                <div id="faction-abilities" class="loadout-section">
                    <h3>Faction Abilities:</h3>
                    <div id="ability-list"></div>
                </div>

                <div id="armor-bonuses" class="loadout-section">
                    <h3>Armor Set Bonuses:</h3>
                    <div id="bonus-info"></div>
                </div>

                <button type="submit">Create Character & Start Playing</button>
                <button type="button" onclick="showLogin()">Back to Login</button>
            </form>
        </div>

        <!-- Game Interface -->
        <div id="game-interface" class="game-section">
            <div class="current-player">
                <h3>Playing As: <span id="player-name"></span></h3>
                <button class="logout-btn" onclick="logout()">Logout</button>
            </div>

            <div class="nav-buttons">
                <button onclick="showLoadoutManagement()">Manage Loadout</button>
                <button onclick="startDuel()">‚öîÔ∏è Duel</button>
                <button onclick="showLeaderboard()">üèÜ Leaderboard</button>
                <button onclick="showCharacterInfo()">üìä Character Info</button>
            </div>

            <div id="player-stats" class="stats-grid"></div>

            <div id="combat-area">
                <h3>Combat Log</h3>
                <div id="combat-log" class="combat-log"></div>
                <button onclick="startDuel()" id="duel-btn">‚öîÔ∏è Start New Duel</button>
            </div>
        </div>

        <!-- Loadout Management -->
        <div id="loadout-management" class="game-section">
            <h2>Loadout Management</h2>
            <div class="nav-buttons">
                <button onclick="showGameInterface()">‚Üê Back to Game</button>
            </div>

            <div class="loadout-grid">
                <div class="loadout-card">
                    <h3>Change Faction</h3>
                    <select id="new-faction" onchange="updateNewAbilities()">
                        <option value="order_of_the_silver_crusade">Order of the Silver Crusade</option>
                        <option value="shadow_covenant">Shadow Covenant</option>
                        <option value="wilderness_tribe">Wilderness Tribe</option>
                    </select>
                    <button onclick="changeFaction()">Apply Faction Change</button>
                </div>

                <div class="loadout-card">
                    <h3>Change Armor Type</h3>
                    <select id="new-armor" onchange="updateNewArmorBonuses()">
                        <option value="cloth">Cloth (Lightfoot)</option>
                        <option value="leather">Leather (Balanced)</option>
                        <option value="metal">Metal (Fortress)</option>
                    </select>
                    <button onclick="changeArmor()">Apply Armor Change</button>
                </div>

                <div class="loadout-card">
                    <h3>Change Weapons</h3>
                    <label>Primary Weapon:</label>
                    <select id="new-weapon1">
                        <option value="fists">Fists (5 dmg, 6 speed)</option>
                        <option value="sword">Sword (15 dmg, 3 speed)</option>
                        <option value="axe">Axe (18 dmg, 2 speed)</option>
                        <option value="mace">Mace (14 dmg, 3 speed)</option>
                        <option value="bow">Bow (12 dmg, 4 speed)</option>
                        <option value="crossbow">Crossbow (16 dmg, 2 speed)</option>
                        <option value="staff">Staff (13 dmg, 3 speed)</option>
                        <option value="knife">Knife (10 dmg, 5 speed)</option>
                        <option value="hammer">Hammer (20 dmg, 1 speed)</option>
                        <option value="shield">Shield (8 dmg, 2 speed)</option>
                    </select>
                    <label>Secondary Weapon:</label>
                    <select id="new-weapon2">
                        <option value="fists">Fists (5 dmg, 6 speed)</option>
                        <option value="sword">Sword (15 dmg, 3 speed)</option>
                        <option value="axe">Axe (18 dmg, 2 speed)</option>
                        <option value="mace">Mace (14 dmg, 3 speed)</option>
                        <option value="bow">Bow (12 dmg, 4 speed)</option>
                        <option value="crossbow">Crossbow (16 dmg, 2 speed)</option>
                        <option value="staff">Staff (13 dmg, 3 speed)</option>
                        <option value="knife">Knife (10 dmg, 5 speed)</option>
                        <option value="hammer">Hammer (20 dmg, 1 speed)</option>
                        <option value="shield">Shield (8 dmg, 2 speed)</option>
                    </select>
                    <button onclick="changeWeapons()">Apply Weapon Changes</button>
                </div>
            </div>

            <div id="new-faction-abilities" class="loadout-section">
                <h3>New Faction Abilities:</h3>
                <div id="new-ability-list"></div>
            </div>

            <div id="new-armor-bonuses" class="loadout-section">
                <h3>New Armor Set Bonuses:</h3>
                <div id="new-bonus-info"></div>
            </div>
        </div>

        <!-- Leaderboard -->
        <div id="leaderboard-section" class="game-section">
            <h2>üèÜ Leaderboard</h2>
            <div class="nav-buttons">
                <button onclick="showGameInterface()">‚Üê Back to Game</button>
                <button onclick="loadLeaderboard()">Refresh</button>
            </div>
            <div id="leaderboard" class="leaderboard"></div>
        </div>

        <!-- Character Info -->
        <div id="character-info" class="game-section">
            <h2>üìä Character Information</h2>
            <div class="nav-buttons">
                <button onclick="showGameInterface()">‚Üê Back to Game</button>
            </div>
            <div id="character-details"></div>
        </div>
    </div>

    <script>
        // Game data
        const FACTIONS = {
            'order_of_the_silver_crusade': {
                name: 'Order of the Silver Crusade',
                description: 'Holy warriors focused on defense and healing',
                passive: 'Divine Protection (10% damage reduction)',
                secondary_passive: 'Holy Resistance (immune to poison)',
                abilities: ['Divine Strike', 'Shield of Faith', 'Healing Light', 'Righteous Fury', 'Purification']
            },
            'shadow_covenant': {
                name: 'Shadow Covenant',
                description: 'Stealthy assassins focused on critical hits',
                passive: 'Shadow Mastery (15% increased crit chance)',
                secondary_passive: 'Stealth Damage (+10% when invisible)',
                abilities: ['Shadow Strike', 'Vanish', 'Poison Blade', 'Assassinate', 'Shadow Clone']
            },
            'wilderness_tribe': {
                name: 'Wilderness Tribe',
                description: 'Nature mages focused on adaptability',
                passive: 'Nature\'s Blessing (5% HP regeneration per turn)',
                secondary_passive: 'Nature Affinity (+10% damage vs slowed enemies)',
                abilities: ['Nature\'s Wrath', 'Thorn Barrier', 'Wild Growth', 'Earthquake', 'Spirit Form']
            }
        };

        const ARMOR_BONUSES = {
            'cloth': {
                name: 'Lightfoot',
                '3_piece': {
                    name: 'Swift Step',
                    effects: '+5% dodge, +2 speed',
                    description: 'Enhanced mobility and evasion'
                },
                '5_piece': {
                    name: 'Wind Walker',
                    effects: '+10% dodge, +5 speed, +5% crit',
                    description: 'Master of speed and precision strikes'
                }
            },
            'leather': {
                name: 'Balanced',
                '3_piece': {
                    name: 'Adaptive Combat',
                    effects: '+5% to all stats, +1 armor pen',
                    description: 'Versatile fighting techniques'
                },
                '5_piece': {
                    name: 'Perfect Balance',
                    effects: '+10% to all stats, +3 armor pen, +5% damage',
                    description: 'Harmonious mastery of all combat arts'
                }
            },
            'metal': {
                name: 'Fortress',
                '3_piece': {
                    name: 'Iron Will',
                    effects: '+3 defense, +5% damage reduction',
                    description: 'Unwavering defensive stance'
                },
                '5_piece': {
                    name: 'Immovable Mountain',
                    effects: '+8 defense, +10% damage reduction, +5% damage reflect',
                    description: 'Unbreakable fortress that strikes back'
                }
            }
        };

        const WEAPONS = {
            'sword': { name: 'Sword', attack: 12, speed: 8, crit_chance: 0.05 },
            'axe': { name: 'Axe', attack: 15, speed: 6, crit_chance: 0.03 },
            'mace': { name: 'Mace', attack: 13, speed: 7, crit_chance: 0.04 },
            'bow': { name: 'Bow', attack: 10, speed: 10, crit_chance: 0.08 },
            'crossbow': { name: 'Crossbow', attack: 14, speed: 5, crit_chance: 0.06 },
            'staff': { name: 'Staff', attack: 8, speed: 9, crit_chance: 0.07 },
            'knife': { name: 'Knife', attack: 9, speed: 12, crit_chance: 0.10 },
            'hammer': { name: 'Hammer', attack: 18, speed: 4, crit_chance: 0.02 },
            'shield': { name: 'Shield', attack: 6, speed: 6, crit_chance: 0.01 }
        };

        let currentPlayer = null;
        let duelInProgress = false;

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            setupLogin();
            checkExistingPlayer();
        });

        function setupLogin() {
            document.getElementById('login-form').addEventListener('submit', handleLogin);
            document.getElementById('character-form').addEventListener('submit', handleCharacterFormSubmit);
        }

        function checkExistingPlayer() {
            const saved = localStorage.getItem('idleDuelistPlayer');
            if (saved) {
                try {
                    currentPlayer = JSON.parse(saved);
                    showGameInterface();
                    document.getElementById('current-username').textContent = currentPlayer.username;
                    document.getElementById('current-player-info').style.display = 'block';
                    updatePlayerStats();
                } catch (e) {
                    console.error('Error loading saved player:', e);
                }
            }
        }

        async function handleLogin(e) {
            e.preventDefault();
            const username = document.getElementById('login-username').value.trim();
            const password = document.getElementById('login-password').value;
            
            if (!username || !password) {
                alert('Please enter both username and password');
                return;
            }

            try {
                const response = await fetch('/login', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username, password })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    currentPlayer = result.player;
                    savePlayerData();
                    showGameInterface();
                    document.getElementById('current-username').textContent = currentPlayer.username;
                    document.getElementById('current-player-info').style.display = 'block';
                    updatePlayerStats();
                    
                    // Clear login form
                    document.getElementById('login-form').reset();
                } else {
                    alert('Login failed: ' + result.error);
                }
            } catch (error) {
                console.error('Login error:', error);
                alert('Error logging in. Please try again.');
            }
        }

        async function handleCharacterFormSubmit(e) {
            e.preventDefault();
            const formData = new FormData(e.target);
            const playerData = Object.fromEntries(formData.entries());
            
            // Validate passwords match
            const password = playerData.password;
            const confirmPassword = playerData.confirm_password;
            
            if (password !== confirmPassword) {
                alert('Passwords do not match!');
                return;
            }
            
            if (password.length < 6) {
                alert('Password must be at least 6 characters long!');
                return;
            }

            try {
                const response = await fetch('/create-player', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(playerData)
                });

                const result = await response.json();
                if (result.success) {
                    currentPlayer = result.player;
                    savePlayerData();
                    showGameInterface();
                    document.getElementById('current-username').textContent = currentPlayer.username;
                    document.getElementById('current-player-info').style.display = 'block';
                    updatePlayerStats();
                    
                    // Clear character form
                    document.getElementById('character-form').reset();
                } else {
                    alert('Error creating character: ' + result.error);
                }
            } catch (error) {
                console.error('Character creation error:', error);
                alert('Error creating character: ' + error.message);
            }
        }

        function savePlayerData() {
            if (currentPlayer) {
                localStorage.setItem('idleDuelistPlayer', JSON.stringify(currentPlayer));
            }
        }

        function logout() {
            currentPlayer = null;
            localStorage.removeItem('idleDuelistPlayer');
            showLogin();
            document.getElementById('current-player-info').style.display = 'none';
        }

        function showLogin() {
            hideAllSections();
            document.getElementById('login-section').classList.add('active');
            document.getElementById('character-creation').classList.remove('active');
        }

        function showCharacterCreation() {
            hideAllSections();
            document.getElementById('character-creation').classList.add('active');
            updateAbilities();
            updateArmorBonuses();
        }

        function showGameInterface() {
            hideAllSections();
            document.getElementById('game-interface').classList.add('active');
            updatePlayerStats();
        }

        function showLoadoutManagement() {
            hideAllSections();
            document.getElementById('loadout-management').classList.add('active');
            
            // Set current values
            document.getElementById('new-faction').value = currentPlayer.faction;
            document.getElementById('new-armor').value = currentPlayer.armor_type;
            document.getElementById('new-weapon1').value = currentPlayer.weapon1;
            document.getElementById('new-weapon2').value = currentPlayer.weapon2;
            
            updateNewAbilities();
            updateNewArmorBonuses();
        }

        function showLeaderboard() {
            hideAllSections();
            document.getElementById('leaderboard-section').classList.add('active');
            loadLeaderboard();
        }

        function showCharacterInfo() {
            hideAllSections();
            document.getElementById('character-info').classList.add('active');
            displayCharacterInfo();
        }

        function hideAllSections() {
            const sections = document.querySelectorAll('.game-section');
            sections.forEach(section => section.classList.remove('active'));
        }

        function updateAbilities() {
            const faction = document.getElementById('faction').value;
            const abilityList = document.getElementById('ability-list');
            
            if (faction && FACTIONS[faction]) {
                const factionData = FACTIONS[faction];
                abilityList.innerHTML = `
                    <p><strong>Faction:</strong> ${factionData.name}</p>
                    <p><strong>Description:</strong> ${factionData.description}</p>
                    <p><strong>Primary Passive:</strong> ${factionData.passive}</p>
                    <p><strong>Secondary Passive:</strong> ${factionData.secondary_passive}</p>
                    <p><strong>Abilities:</strong> ${factionData.abilities.join(', ')}</p>
                `;
            } else {
                abilityList.innerHTML = '<p>Select a faction to see abilities</p>';
            }
        }

        function updateArmorBonuses() {
            const armorType = document.getElementById('armor_type').value;
            const bonusInfo = document.getElementById('bonus-info');
            
            if (armorType && ARMOR_BONUSES[armorType]) {
                const armorData = ARMOR_BONUSES[armorType];
                bonusInfo.innerHTML = `
                    <div class="bonus-info">
                        <h4>3-Piece Set: ${armorData['3_piece'].name}</h4>
                        <p><strong>Effects:</strong> ${armorData['3_piece'].effects}</p>
                        <p><strong>Description:</strong> ${armorData['3_piece'].description}</p>
                    </div>
                    <div class="bonus-info">
                        <h4>5-Piece Set: ${armorData['5_piece'].name}</h4>
                        <p><strong>Effects:</strong> ${armorData['5_piece'].effects}</p>
                        <p><strong>Description:</strong> ${armorData['5_piece'].description}</p>
                    </div>
                `;
            } else {
                bonusInfo.innerHTML = '<p>Select armor type to see set bonuses</p>';
            }
        }

        function updateNewAbilities() {
            const faction = document.getElementById('new-faction').value;
            const abilityList = document.getElementById('new-ability-list');
            
            if (faction && FACTIONS[faction]) {
                const factionData = FACTIONS[faction];
                abilityList.innerHTML = `
                    <p><strong>Faction:</strong> ${factionData.name}</p>
                    <p><strong>Description:</strong> ${factionData.description}</p>
                    <p><strong>Primary Passive:</strong> ${factionData.passive}</p>
                    <p><strong>Secondary Passive:</strong> ${factionData.secondary_passive}</p>
                    <p><strong>Abilities:</strong> ${factionData.abilities.join(', ')}</p>
                `;
            }
        }

        function updateNewArmorBonuses() {
            const armorType = document.getElementById('new-armor').value;
            const bonusInfo = document.getElementById('new-bonus-info');
            
            if (armorType && ARMOR_BONUSES[armorType]) {
                const armorData = ARMOR_BONUSES[armorType];
                bonusInfo.innerHTML = `
                    <div class="bonus-info">
                        <h4>3-Piece Set: ${armorData['3_piece'].name}</h4>
                        <p><strong>Effects:</strong> ${armorData['3_piece'].effects}</p>
                        <p><strong>Description:</strong> ${armorData['3_piece'].description}</p>
                    </div>
                    <div class="bonus-info">
                        <h4>5-Piece Set: ${armorData['5_piece'].name}</h4>
                        <p><strong>Effects:</strong> ${armorData['5_piece'].effects}</p>
                        <p><strong>Description:</strong> ${armorData['5_piece'].description}</p>
                    </div>
                `;
            }
        }

        function updatePlayerStats() {
            if (!currentPlayer) return;

            const statsContainer = document.getElementById('player-stats');
            const weapon1Data = WEAPONS[currentPlayer.weapon1] || { attack: 0, speed: 0, crit_chance: 0 };
            const weapon2Data = WEAPONS[currentPlayer.weapon2] || { attack: 0, speed: 0, crit_chance: 0 };
            
            const totalAttack = weapon1Data.attack + weapon2Data.attack;
            const totalSpeed = Math.floor((weapon1Data.speed + weapon2Data.speed) / 2);
            const totalCrit = ((weapon1Data.crit_chance + weapon2Data.crit_chance) / 2 * 100).toFixed(1);

            statsContainer.innerHTML = `
                <div class="stat-card">
                    <h4>‚öîÔ∏è Attack</h4>
                    <div class="stat-value">${totalAttack}</div>
                </div>
                <div class="stat-card">
                    <h4>üèÉ Speed</h4>
                    <div class="stat-value">${totalSpeed}</div>
                </div>
                <div class="stat-card">
                    <h4>üí• Crit Chance</h4>
                    <div class="stat-value">${totalCrit}%</div>
                </div>
                <div class="stat-card">
                    <h4>üèÜ Wins</h4>
                    <div class="stat-value">${currentPlayer.wins || 0}</div>
                </div>
                <div class="stat-card">
                    <h4>üíÄ Losses</h4>
                    <div class="stat-value">${currentPlayer.losses || 0}</div>
                </div>
                <div class="stat-card">
                    <h4>‚öñÔ∏è Win Rate</h4>
                    <div class="stat-value">${calculateWinRate()}%</div>
                </div>
            `;

            document.getElementById('player-name').textContent = currentPlayer.username;
        }

        function calculateWinRate() {
            if (!currentPlayer) return 0;
            const total = (currentPlayer.wins || 0) + (currentPlayer.losses || 0);
            return total > 0 ? Math.round(((currentPlayer.wins || 0) / total) * 100) : 0;
        }

        async function startDuel() {
            if (duelInProgress) return;
            duelInProgress = true;
            
            const duelBtn = document.getElementById('duel-btn');
            duelBtn.disabled = true;
            duelBtn.textContent = '‚öîÔ∏è Dueling...';

            try {
                const response = await fetch('/duel', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username: currentPlayer.username })
                });

                const result = await response.json();
                if (result.success) {
                    displayCombatLog(result.combat_log);
                    currentPlayer.wins = result.player_wins;
                    currentPlayer.losses = result.player_losses;
                    savePlayerData();
                    updatePlayerStats();
                } else {
                    alert('Duel failed: ' + result.error);
                }
            } catch (error) {
                console.error('Duel error:', error);
                alert('Error starting duel: ' + error.message);
            } finally {
                duelInProgress = false;
                duelBtn.disabled = false;
                duelBtn.textContent = '‚öîÔ∏è Start New Duel';
            }
        }

        function displayCombatLog(combatLog) {
            const logContainer = document.getElementById('combat-log');
            logContainer.innerHTML = '';
            
            // Display combat log incrementally with delays
            let currentIndex = 0;
            
            function displayNextEntry() {
                if (currentIndex >= combatLog.length) {
                    // Combat finished, scroll to bottom
                    logContainer.scrollTop = logContainer.scrollHeight;
                    return;
                }
                
                const logEntry = combatLog[currentIndex];
                const p = document.createElement('p');
                
                // Handle HTML content (like ability icons)
                if (logEntry.includes('<img')) {
                    p.innerHTML = logEntry;
                } else {
                    p.textContent = logEntry;
                }
                
                // Add appropriate CSS classes based on content
                if (logEntry.includes('uses') && logEntry.includes('ability')) {
                    p.classList.add('ability-used');
                } else if (logEntry.includes('damage') && !logEntry.includes('heals')) {
                    p.classList.add('damage-dealt');
                } else if (logEntry.includes('heals') || logEntry.includes('healing')) {
                    p.classList.add('healing');
                } else if (logEntry.includes('dodges') || logEntry.includes('dodge')) {
                    p.classList.add('dodge');
                } else if (logEntry.includes('critical') || logEntry.includes('crit')) {
                    p.classList.add('crit');
                } else if (logEntry.includes('VICTORY') || logEntry.includes('WINS')) {
                    p.classList.add('victory');
                } else if (logEntry.includes('DEFEAT') || logEntry.includes('LOSES')) {
                    p.classList.add('defeat');
                } else if (logEntry.includes('Round')) {
                    p.classList.add('round-header');
                } else if (logEntry.includes('Turn')) {
                    p.classList.add('turn-header');
                }
                
                // Add fade-in animation
                p.style.opacity = '0';
                p.style.transform = 'translateY(10px)';
                logContainer.appendChild(p);
                
                // Animate in
                setTimeout(() => {
                    p.style.transition = 'opacity 0.3s ease, transform 0.3s ease';
                    p.style.opacity = '1';
                    p.style.transform = 'translateY(0)';
                }, 10);
                
                // Scroll to bottom
                logContainer.scrollTop = logContainer.scrollHeight;
                
                currentIndex++;
                
                // Determine delay based on entry type
                let delay = 500; // Default 0.5 seconds
                if (logEntry.includes('Round')) {
                    delay = 800; // Longer pause for round headers
                } else if (logEntry.includes('Turn')) {
                    delay = 600; // Medium pause for turn headers
                } else if (logEntry.includes('VICTORY') || logEntry.includes('WINS') || logEntry.includes('DEFEAT')) {
                    delay = 1000; // Longer pause for final results
                } else if (logEntry.includes('damage') || logEntry.includes('heals')) {
                    delay = 700; // Slightly longer for important actions
                }
                
                setTimeout(displayNextEntry, delay);
            }
            
            // Start displaying entries
            displayNextEntry();
        }

        async function changeFaction() {
            const newFaction = document.getElementById('new-faction').value;
            if (newFaction === currentPlayer.faction) {
                alert('You already have this faction selected!');
                return;
            }

            if (confirm(`Are you sure you want to change faction to ${FACTIONS[newFaction].name}?`)) {
                try {
                    const response = await fetch('/update-loadout', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            username: currentPlayer.username,
                            faction: newFaction
                        })
                    });

                    const result = await response.json();
                    if (result.success) {
                        currentPlayer.faction = newFaction;
                        savePlayerData();
                        alert('Faction changed successfully!');
                        updatePlayerStats();
                    } else {
                        alert('Error changing faction: ' + result.error);
                    }
                } catch (error) {
                    alert('Error changing faction: ' + error.message);
                }
            }
        }

        async function changeArmor() {
            const newArmor = document.getElementById('new-armor').value;
            if (newArmor === currentPlayer.armor_type) {
                alert('You already have this armor type selected!');
                return;
            }

            if (confirm(`Are you sure you want to change armor to ${ARMOR_BONUSES[newArmor].name}?`)) {
                try {
                    const response = await fetch('/update-loadout', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            username: currentPlayer.username,
                            armor_type: newArmor
                        })
                    });

                    const result = await response.json();
                    if (result.success) {
                        currentPlayer.armor_type = newArmor;
                        savePlayerData();
                        alert('Armor changed successfully!');
                        updatePlayerStats();
                    } else {
                        alert('Error changing armor: ' + result.error);
                    }
                } catch (error) {
                    alert('Error changing armor: ' + error.message);
                }
            }
        }

        async function changeWeapons() {
            const newWeapon1 = document.getElementById('new-weapon1').value;
            const newWeapon2 = document.getElementById('new-weapon2').value;
            
            if (newWeapon1 === currentPlayer.weapon1 && newWeapon2 === currentPlayer.weapon2) {
                alert('You already have these weapons selected!');
                return;
            }

            if (confirm(`Are you sure you want to change weapons to ${WEAPONS[newWeapon1].name} and ${WEAPONS[newWeapon2].name}?`)) {
                try {
                    const response = await fetch('/update-loadout', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            username: currentPlayer.username,
                            weapon1: newWeapon1,
                            weapon2: newWeapon2
                        })
                    });

                    const result = await response.json();
                    if (result.success) {
                        currentPlayer.weapon1 = newWeapon1;
                        currentPlayer.weapon2 = newWeapon2;
                        savePlayerData();
                        alert('Weapons changed successfully!');
                        updatePlayerStats();
                    } else {
                        alert('Error changing weapons: ' + result.error);
                    }
                } catch (error) {
                    alert('Error changing weapons: ' + error.message);
                }
            }
        }

        async function loadLeaderboard() {
            try {
                const response = await fetch('/leaderboard');
                const result = await response.json();
                
                if (result.success) {
                    const leaderboard = document.getElementById('leaderboard');
                    leaderboard.innerHTML = '';

                    if (result.leaderboard && result.leaderboard.length > 0) {
                        result.leaderboard.forEach((player) => {
                            const item = document.createElement('div');
                            item.className = 'leaderboard-item';
                            
                            const botIndicator = player.is_bot ? 'ü§ñ ' : 'üë§ ';
                            const factionIcon = getFactionIcon(player.faction);
                            
                            item.innerHTML = `
                                <div style="display: flex; justify-content: space-between; align-items: center; width: 100%;">
                                    <div>
                                        <span style="font-weight: bold;">#${player.rank} ${botIndicator}${player.username}</span>
                                        <br>
                                        <small style="color: #ccc;">${factionIcon} ${player.faction} ‚Ä¢ ${player.armor_type} Armor</small>
                                    </div>
                                    <div style="text-align: right;">
                                        <div style="font-weight: bold;">Rating: ${player.rating}</div>
                                        <div>${player.wins}W / ${player.losses}L (${player.win_rate}%)</div>
                                    </div>
                                </div>
                            `;
                            leaderboard.appendChild(item);
                        });
                    } else {
                        leaderboard.innerHTML = '<div style="text-align: center; padding: 20px; color: #ccc;">No players found. Create a character to get started!</div>';
                    }
                } else {
                    console.error('Leaderboard error:', result.error);
                    leaderboard.innerHTML = '<div style="text-align: center; padding: 20px; color: #ff6b6b;">Error loading leaderboard: ' + result.error + '</div>';
                }
            } catch (error) {
                console.error('Leaderboard error:', error);
                const leaderboard = document.getElementById('leaderboard');
                leaderboard.innerHTML = '<div style="text-align: center; padding: 20px; color: #ff6b6b;">Failed to load leaderboard. Please try again.</div>';
            }
        }

        function getFactionIcon(factionName) {
            const icons = {
                'Order of the Silver Crusade': '‚öîÔ∏è',
                'Shadow Covenant': 'üåë',
                'Wilderness Tribe': 'üåø'
            };
            return icons[factionName] || '‚öîÔ∏è';
        }

        function displayCharacterInfo() {
            if (!currentPlayer) return;

            const factionData = FACTIONS[currentPlayer.faction];
            const armorData = ARMOR_BONUSES[currentPlayer.armor_type];
            const weapon1Data = WEAPONS[currentPlayer.weapon1];
            const weapon2Data = WEAPONS[currentPlayer.weapon2];

            const details = document.getElementById('character-details');
            details.innerHTML = `
                <div class="loadout-section">
                    <h3>Character: ${currentPlayer.username}</h3>
                    <p><strong>Faction:</strong> ${factionData.name}</p>
                    <p><strong>Armor Type:</strong> ${armorData.name}</p>
                    <p><strong>Primary Weapon:</strong> ${weapon1Data.name}</p>
                    <p><strong>Secondary Weapon:</strong> ${weapon2Data.name}</p>
                </div>
                
                <div class="loadout-section">
                    <h3>Faction Abilities</h3>
                    <p><strong>Primary Passive:</strong> ${factionData.passive}</p>
                    <p><strong>Secondary Passive:</strong> ${factionData.secondary_passive}</p>
                    <p><strong>Abilities:</strong> ${factionData.abilities.join(', ')}</p>
                </div>

                <div class="loadout-section">
                    <h3>Armor Set Bonuses</h3>
                    <div class="bonus-info">
                        <h4>3-Piece Set: ${armorData['3_piece'].name}</h4>
                        <p><strong>Effects:</strong> ${armorData['3_piece'].effects}</p>
                        <p><strong>Description:</strong> ${armorData['3_piece'].description}</p>
                    </div>
                    <div class="bonus-info">
                        <h4>5-Piece Set: ${armorData['5_piece'].name}</h4>
                        <p><strong>Effects:</strong> ${armorData['5_piece'].effects}</p>
                        <p><strong>Description:</strong> ${armorData['5_piece'].description}</p>
                    </div>
                </div>

                <div class="loadout-section">
                    <h3>Combat Statistics</h3>
                    <p><strong>Total Wins:</strong> ${currentPlayer.wins || 0}</p>
                    <p><strong>Total Losses:</strong> ${currentPlayer.losses || 0}</p>
                    <p><strong>Win Rate:</strong> ${calculateWinRate()}%</p>
                    <p><strong>Total Duels:</strong> ${(currentPlayer.wins || 0) + (currentPlayer.losses || 0)}</p>
                </div>
            `;
        }

        // Make functions globally available
        window.updateAbilities = updateAbilities;
        window.updateArmorBonuses = updateArmorBonuses;
        window.updateNewAbilities = updateNewAbilities;
        window.updateNewArmorBonuses = updateNewArmorBonuses;
    </script>
</body>
</html>
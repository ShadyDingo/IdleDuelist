<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>⚔️ IdleDuelist - Full Game ⚔️</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            color: #fff;
            min-height: 100vh;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        h1 {
            text-align: center;
            margin-bottom: 30px;
            font-size: 2.5em;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
        }

        .game-section {
            display: none;
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 30px;
            margin-bottom: 20px;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .game-section.active {
            display: block;
        }

        .form-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
        }

        input, select {
            width: 100%;
            padding: 12px;
            border: none;
            border-radius: 8px;
            background: rgba(255, 255, 255, 0.9);
            color: #333;
            font-size: 16px;
        }

        button {
            background: linear-gradient(45deg, #ff6b6b, #ee5a24);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
            transition: all 0.3s ease;
            margin: 5px;
        }

        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        }

        .nav-buttons {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 20px;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .stat-item {
            background: rgba(255, 255, 255, 0.1);
            padding: 15px;
            border-radius: 10px;
            text-align: center;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .stat-value {
            font-size: 1.5em;
            font-weight: bold;
            color: #ffd700;
        }

        .duel-log {
            background: rgba(0, 0, 0, 0.5);
            padding: 20px;
            border-radius: 10px;
            max-height: 400px;
            overflow-y: auto;
            font-family: monospace;
            font-size: 14px;
            line-height: 1.5;
        }

        .leaderboard {
            display: grid;
            gap: 10px;
        }

        .leaderboard-item {
            background: rgba(255, 255, 255, 0.1);
            padding: 15px;
            border-radius: 10px;
            display: grid;
            grid-template-columns: auto 1fr auto auto auto;
            gap: 15px;
            align-items: center;
        }

        .rank {
            font-size: 1.2em;
            font-weight: bold;
            color: #ffd700;
        }

        .character-info {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }

        .info-section {
            background: rgba(255, 255, 255, 0.1);
            padding: 20px;
            border-radius: 10px;
        }

        .faction-info {
            background: rgba(255, 255, 255, 0.1);
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
        }

        .armor-set-info {
            background: rgba(255, 255, 255, 0.1);
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
        }

        .ability-list {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
        }

        .ability-item {
            background: rgba(255, 255, 255, 0.1);
            padding: 15px;
            border-radius: 10px;
            border-left: 4px solid #ffd700;
        }

        .equipment-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
        }

        .equipment-item {
            background: rgba(255, 255, 255, 0.1);
            padding: 15px;
            border-radius: 10px;
            text-align: center;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .error {
            color: #ff6b6b;
            background: rgba(255, 107, 107, 0.1);
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
        }

        .success {
            color: #51cf66;
            background: rgba(81, 207, 102, 0.1);
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
        }

        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }
            
            h1 {
                font-size: 2em;
            }
            
            .nav-buttons {
                flex-direction: column;
            }
            
            .character-info {
                grid-template-columns: 1fr;
            }
            
            .leaderboard-item {
                grid-template-columns: 1fr;
                text-align: center;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>⚔️ IdleDuelist - Full Game Edition ⚔️</h1>
        
        <!-- Login/Create Account -->
        <div id="login-section" class="game-section active">
            <h2>Welcome to IdleDuelist</h2>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                <div>
                    <h3>Login to Existing Account</h3>
                    <form id="login-form">
                        <div class="form-group">
                            <label for="login-username">Username:</label>
                            <input type="text" id="login-username" name="username" required>
                        </div>
                        <button type="submit">Login</button>
                    </form>
                </div>
                <div>
                    <h3>Create New Account</h3>
                    <button onclick="showCharacterCreation()">Create New Character</button>
                </div>
            </div>
        </div>

        <!-- Character Creation -->
        <div id="character-creation" class="game-section">
            <h2>Create Your Character</h2>
            <form id="character-form">
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                    <div>
                        <div class="form-group">
                            <label for="username">Character Name:</label>
                            <input type="text" id="username" name="username" required>
                        </div>
                        
                        <div class="form-group">
                            <label for="faction">Faction:</label>
                            <select id="faction" name="faction" onchange="updateAbilities()">
                                <option value="order_of_the_silver_crusade">Order of the Silver Crusade</option>
                                <option value="shadow_covenant">Shadow Covenant</option>
                                <option value="wilderness_tribe">Wilderness Tribe</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label for="armor_type">Armor Type:</label>
                            <select id="armor_type" name="armor_type" onchange="updateArmorInfo()">
                                <option value="cloth">Cloth (High Speed, Low Defense)</option>
                                <option value="leather">Leather (Balanced)</option>
                                <option value="metal">Metal (Low Speed, High Defense)</option>
                            </select>
                        </div>
                    </div>
                    
                    <div>
                        <div class="form-group">
                            <label for="weapon1">Primary Weapon:</label>
                            <select id="weapon1" name="weapon1">
                                <option value="sword">Sword</option>
                                <option value="axe">Axe</option>
                                <option value="bow">Bow</option>
                                <option value="crossbow">Crossbow</option>
                                <option value="knife">Knife</option>
                                <option value="mace">Mace</option>
                                <option value="hammer">Hammer</option>
                                <option value="shield">Shield</option>
                                <option value="staff">Staff</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label for="weapon2">Secondary Weapon:</label>
                            <select id="weapon2" name="weapon2">
                                <option value="sword">Sword</option>
                                <option value="axe">Axe</option>
                                <option value="bow">Bow</option>
                                <option value="crossbow">Crossbow</option>
                                <option value="knife">Knife</option>
                                <option value="mace">Mace</option>
                                <option value="hammer">Hammer</option>
                                <option value="shield">Shield</option>
                                <option value="staff">Staff</option>
                            </select>
                        </div>
                    </div>
                </div>
                
                <!-- Faction Info -->
                <div class="faction-info">
                    <h3 id="faction-name">Order of the Silver Crusade</h3>
                    <p id="faction-description">Holy warriors focused on defense and healing</p>
                    <div>
                        <strong>Primary Passive:</strong> <span id="faction-passive">Divine Protection - 10% damage reduction</span>
                    </div>
                    <div>
                        <strong>Secondary Passive:</strong> <span id="faction-secondary">Holy Resistance - Immune to poison effects</span>
                    </div>
                    <div>
                        <strong>Abilities:</strong> <span id="faction-abilities">Divine Strike, Shield of Faith, Healing Light, Righteous Fury, Purification</span>
                    </div>
                </div>
                
                <!-- Armor Set Info -->
                <div class="armor-set-info">
                    <h3 id="armor-set-name">Lightfoot Set</h3>
                    <div>
                        <strong>3-Piece Bonus:</strong> <span id="armor-3-piece">Swift Step - +5% dodge, +2 speed</span>
                    </div>
                    <div>
                        <strong>5-Piece Bonus:</strong> <span id="armor-5-piece">Wind Walker - +10% dodge, +5 speed, +5% crit</span>
                    </div>
                </div>
                
                <button type="submit">Create Character & Start Playing</button>
            </form>
        </div>

        <!-- Game Interface -->
        <div id="game-interface" class="game-section">
            <h2>Welcome, <span id="player-name">Player</span>!</h2>
            
            <div class="stats-grid">
                <div class="stat-item">
                    <div>Rating</div>
                    <div class="stat-value" id="rating">1200</div>
                </div>
                <div class="stat-item">
                    <div>Wins</div>
                    <div class="stat-value" id="wins">0</div>
                </div>
                <div class="stat-item">
                    <div>Losses</div>
                    <div class="stat-value" id="losses">0</div>
                </div>
                <div class="stat-item">
                    <div>HP</div>
                    <div class="stat-value" id="hp">100</div>
                </div>
                <div class="stat-item">
                    <div>Attack</div>
                    <div class="stat-value" id="attack">50</div>
                </div>
                <div class="stat-item">
                    <div>Defense</div>
                    <div class="stat-value" id="defense">20</div>
                </div>
                <div class="stat-item">
                    <div>Speed</div>
                    <div class="stat-value" id="speed">25</div>
                </div>
                <div class="stat-item">
                    <div>Crit Chance</div>
                    <div class="stat-value" id="crit">5%</div>
                </div>
            </div>
            
            <div class="nav-buttons">
                <button onclick="findDuel()">⚔️ Find Duel</button>
                <button onclick="showLeaderboard()">🏆 Leaderboard</button>
                <button onclick="showCharacterInfo()">👤 Character Info</button>
                <button onclick="logout()" style="background: #f44336;">🚪 Logout</button>
            </div>
            
            <div id="duel-log" class="duel-log" style="display: none;"></div>
        </div>
        
        <!-- Leaderboard -->
        <div id="leaderboard" class="game-section">
            <h2>🏆 Leaderboard</h2>
            <div id="leaderboard-content" class="leaderboard">
                <!-- Leaderboard items will be loaded here -->
            </div>
            <button onclick="showGameInterface()">← Back to Game</button>
        </div>
        
        <!-- Character Info -->
        <div id="character-info" class="game-section">
            <h2>👤 Character Information</h2>
            <div class="character-info">
                <div>
                    <div class="info-section">
                        <h3>Basic Info</h3>
                        <div><strong>Name:</strong> <span id="info-name">-</span></div>
                        <div><strong>Faction:</strong> <span id="info-faction">-</span></div>
                        <div><strong>Armor Type:</strong> <span id="info-armor">-</span></div>
                        <div><strong>Rating:</strong> <span id="info-rating">-</span></div>
                        <div><strong>Record:</strong> <span id="info-record">-</span></div>
                    </div>
                    
                    <div class="info-section">
                        <h3>Current Abilities</h3>
                        <div id="current-abilities">
                            <!-- Abilities will be loaded here -->
                        </div>
                    </div>
                </div>
                
                <div>
                    <div class="info-section">
                        <h3>Equipment</h3>
                        <div id="equipment-display" class="equipment-grid">
                            <!-- Equipment will be loaded here -->
                        </div>
                    </div>
                    
                    <div class="info-section">
                        <h3>Faction Passives</h3>
                        <div id="faction-passives">
                            <!-- Passives will be loaded here -->
                        </div>
                    </div>
                </div>
            </div>
            <button onclick="showGameInterface()">← Back to Game</button>
        </div>
    </div>

    <script>
        let currentPlayer = null;
        let gameData = null;

        // Game data constants
        const FACTION_DATA = {
            'order_of_the_silver_crusade': {
                name: 'Order of the Silver Crusade',
                description: 'Holy warriors focused on defense and healing',
                passive: 'Divine Protection - 10% damage reduction',
                secondary: 'Holy Resistance - Immune to poison effects',
                abilities: ['Divine Strike', 'Shield of Faith', 'Healing Light', 'Righteous Fury', 'Purification']
            },
            'shadow_covenant': {
                name: 'Shadow Covenant',
                description: 'Stealthy assassins focused on critical hits',
                passive: 'Shadow Mastery - 15% increased crit chance',
                secondary: 'Stealth Damage - +10% damage when invisible',
                abilities: ['Shadow Strike', 'Vanish', 'Poison Blade', 'Assassinate', 'Shadow Clone']
            },
            'wilderness_tribe': {
                name: 'Wilderness Tribe',
                description: 'Nature mages focused on adaptability',
                passive: "Nature's Blessing - 5% HP regeneration per turn",
                secondary: 'Nature Affinity - +10% damage vs slowed enemies',
                abilities: ["Nature's Wrath", 'Thorn Barrier', 'Wild Growth', 'Earthquake', 'Spirit Form']
            }
        };

        const ARMOR_SET_BONUSES = {
            'cloth': {
                name: 'Lightfoot',
                '3_piece': 'Swift Step - +5% dodge, +2 speed',
                '5_piece': 'Wind Walker - +10% dodge, +5 speed, +5% crit'
            },
            'leather': {
                name: 'Balanced',
                '3_piece': 'Adaptive Combat - +5% to all stats, +1 armor pen',
                '5_piece': 'Perfect Balance - +10% to all stats, +3 armor pen, +5% damage'
            },
            'metal': {
                name: 'Fortress',
                '3_piece': 'Iron Will - +3 defense, +5% damage reduction',
                '5_piece': 'Immovable Mountain - +8 defense, +10% damage reduction, +5% damage reflect'
            }
        };
        
        // Initialize when DOM loads
        document.addEventListener('DOMContentLoaded', function() {
            updateAbilities();
            updateArmorInfo();
            setupForm();
            setupLogin();
            checkExistingPlayer();
            loadGameData();
        });
        
        // Load game data from server
        async function loadGameData() {
            try {
                const response = await fetch('/game-data');
                gameData = await response.json();
                console.log('Game data loaded:', gameData);
            } catch (error) {
                console.error('Error loading game data:', error);
            }
        }
        
        // Update abilities display
        function updateAbilities() {
            const faction = document.getElementById('faction').value;
            const factionInfo = FACTION_DATA[faction];
            
            document.getElementById('faction-name').textContent = factionInfo.name;
            document.getElementById('faction-description').textContent = factionInfo.description;
            document.getElementById('faction-passive').textContent = factionInfo.passive;
            document.getElementById('faction-secondary').textContent = factionInfo.secondary;
            document.getElementById('faction-abilities').textContent = factionInfo.abilities.join(', ');
        }
        
        // Update armor set info
        function updateArmorInfo() {
            const armorType = document.getElementById('armor_type').value;
            const armorInfo = ARMOR_SET_BONUSES[armorType];
            
            document.getElementById('armor-set-name').textContent = armorInfo.name + ' Set';
            document.getElementById('armor-3-piece').textContent = armorInfo['3_piece'];
            document.getElementById('armor-5-piece').textContent = armorInfo['5_piece'];
        }
        
        // Setup form submission
        function setupForm() {
            const form = document.getElementById('character-form');
            if (form) {
                form.addEventListener('submit', handleCharacterCreation);
            }
        }
        
        // Setup login form
        function setupLogin() {
            const loginForm = document.getElementById('login-form');
            if (loginForm) {
                loginForm.addEventListener('submit', handleLogin);
            }
        }
        
        // Check for existing player in localStorage
        function checkExistingPlayer() {
            const savedPlayer = localStorage.getItem('idleduelist_player');
            if (savedPlayer) {
                try {
                    currentPlayer = JSON.parse(savedPlayer);
                    console.log('Found saved player:', currentPlayer.username);
                    showGameInterface();
                    updatePlayerDisplay();
                } catch (e) {
                    console.log('Invalid saved player data');
                    localStorage.removeItem('idleduelist_player');
                }
            }
        }
        
        // Handle character creation
        async function handleCharacterCreation(e) {
            e.preventDefault();
            const formData = new FormData(e.target);
            const playerData = Object.fromEntries(formData.entries());
            
            try {
                const response = await fetch('/create-player', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(playerData)
                });
                
                const result = await response.json();
                
                if (result.success) {
                    currentPlayer = result.player;
                    localStorage.setItem('idleduelist_player', JSON.stringify(currentPlayer));
                    showGameInterface();
                    updatePlayerDisplay();
                } else {
                    alert('Error: ' + result.error);
                }
            } catch (error) {
                console.error('Error:', error);
                alert('Error: ' + error.message);
            }
        }
        
        // Handle login
        async function handleLogin(e) {
            e.preventDefault();
            const formData = new FormData(e.target);
            const username = formData.get('username');
            
            try {
                const response = await fetch('/get-player/' + encodeURIComponent(username));
                const result = await response.json();
                
                if (result.success) {
                    currentPlayer = result.player;
                    localStorage.setItem('idleduelist_player', JSON.stringify(currentPlayer));
                    showGameInterface();
                    updatePlayerDisplay();
                    alert('Welcome back, ' + username + '!');
                } else {
                    alert('Player not found. Please create a new character.');
                    showCharacterCreation();
                }
            } catch (error) {
                console.error('Login error:', error);
                alert('Error logging in: ' + error.message);
            }
        }
        
        // Save player data
        function savePlayerData() {
            if (currentPlayer) {
                localStorage.setItem('idleduelist_player', JSON.stringify(currentPlayer));
            }
        }
        
        // Logout function
        function logout() {
            currentPlayer = null;
            localStorage.removeItem('idleduelist_player');
            showLogin();
        }
        
        // Show different sections
        function showSection(sectionId) {
            document.querySelectorAll('.game-section').forEach(section => {
                section.classList.remove('active');
            });
            document.getElementById(sectionId).classList.add('active');
        }
        
        function showLogin() {
            showSection('login-section');
        }
        
        function showCharacterCreation() {
            showSection('character-creation');
        }
        
        function showGameInterface() {
            showSection('game-interface');
        }
        
        function showLeaderboard() {
            showSection('leaderboard');
            loadLeaderboard();
        }
        
        function showCharacterInfo() {
            showSection('character-info');
            loadCharacterInfo();
        }
        
        // Update player display
        function updatePlayerDisplay() {
            if (!currentPlayer) return;
            
            document.getElementById('player-name').textContent = currentPlayer.username;
            document.getElementById('rating').textContent = currentPlayer.rating || 1200;
            document.getElementById('wins').textContent = currentPlayer.wins || 0;
            document.getElementById('losses').textContent = currentPlayer.losses || 0;
            document.getElementById('hp').textContent = currentPlayer.get_total_hp ? currentPlayer.get_total_hp() : 100;
            document.getElementById('attack').textContent = currentPlayer.get_total_damage ? currentPlayer.get_total_damage() : 50;
            document.getElementById('defense').textContent = currentPlayer.get_total_defense ? currentPlayer.get_total_defense() : 20;
            document.getElementById('speed').textContent = currentPlayer.get_total_speed ? currentPlayer.get_total_speed() : 25;
            document.getElementById('crit').textContent = (currentPlayer.get_total_crit_chance ? Math.round(currentPlayer.get_total_crit_chance() * 100) : 5) + '%';
        }
        
        // Find duel
        async function findDuel() {
            if (!currentPlayer) return;
            
            const duelLog = document.getElementById('duel-log');
            duelLog.style.display = 'block';
            duelLog.innerHTML = '<div>⚔️ Finding opponent...</div>';
            
            try {
                const response = await fetch('/duel', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({player_id: currentPlayer.id})
                });
                
                const result = await response.json();
                
                if (result.success) {
                    displayDuelResult(result);
                    currentPlayer = result.updated_player;
                    savePlayerData();
                    updatePlayerDisplay();
                } else {
                    duelLog.innerHTML = '<div class="error">Error: ' + result.error + '</div>';
                }
            } catch (error) {
                duelLog.innerHTML = '<div class="error">Error: ' + error.message + '</div>';
            }
        }
        
        // Display duel result
        function displayDuelResult(result) {
            const duelLog = document.getElementById('duel-log');
            const duelData = result.duel_result;
            
            let logHTML = '<div class="success">' + duelData.result + '</div>';
            logHTML += '<div><strong>Turns:</strong> ' + duelData.turns + '</div>';
            logHTML += '<div><strong>Final HP:</strong> You: ' + duelData.player1_hp + ', Opponent: ' + duelData.player2_hp + '</div>';
            logHTML += '<div><strong>Combat Log:</strong></div>';
            
            if (duelData.log && duelData.log.length > 0) {
                duelData.log.forEach(entry => {
                    logHTML += '<div>' + entry + '</div>';
                });
            }
            
            duelLog.innerHTML = logHTML;
        }
        
        // Load leaderboard
        async function loadLeaderboard() {
            try {
                const response = await fetch('/leaderboard');
                const result = await response.json();
                
                if (result.success) {
                    const leaderboardContent = document.getElementById('leaderboard-content');
                    leaderboardContent.innerHTML = '';
                    
                    result.leaderboard.forEach(player => {
                        const item = document.createElement('div');
                        item.className = 'leaderboard-item';
                        item.innerHTML = `
                            <div class="rank">#${player.rank}</div>
                            <div><strong>${player.username}</strong><br><small>${player.faction} • ${player.armor_type}</small></div>
                            <div>${player.rating}</div>
                            <div>${player.wins}W</div>
                            <div>${player.losses}L</div>
                        `;
                        leaderboardContent.appendChild(item);
                    });
                }
            } catch (error) {
                console.error('Error loading leaderboard:', error);
            }
        }
        
        // Load character info
        function loadCharacterInfo() {
            if (!currentPlayer) return;
            
            document.getElementById('info-name').textContent = currentPlayer.username;
            document.getElementById('info-faction').textContent = FACTION_DATA[currentPlayer.faction]?.name || currentPlayer.faction;
            document.getElementById('info-armor').textContent = currentPlayer.armor_type?.charAt(0).toUpperCase() + currentPlayer.armor_type?.slice(1) || 'Unknown';
            document.getElementById('info-rating').textContent = currentPlayer.rating || 1200;
            document.getElementById('info-record').textContent = (currentPlayer.wins || 0) + 'W - ' + (currentPlayer.losses || 0) + 'L';
            
            // Load abilities
            const abilitiesContainer = document.getElementById('current-abilities');
            abilitiesContainer.innerHTML = '';
            if (currentPlayer.abilities) {
                currentPlayer.abilities.forEach(ability => {
                    const div = document.createElement('div');
                    div.className = 'ability-item';
                    div.innerHTML = '<strong>' + ability + '</strong>';
                    abilitiesContainer.appendChild(div);
                });
            }
            
            // Load equipment
            const equipmentContainer = document.getElementById('equipment-display');
            equipmentContainer.innerHTML = '';
            if (currentPlayer.equipment) {
                Object.entries(currentPlayer.equipment).forEach(([slot, item]) => {
                    const div = document.createElement('div');
                    div.className = 'equipment-item';
                    div.innerHTML = '<strong>' + slot + '</strong><br>' + (item.name || 'Unknown');
                    equipmentContainer.appendChild(div);
                });
            }
            
            // Load faction passives
            const passivesContainer = document.getElementById('faction-passives');
            const factionInfo = FACTION_DATA[currentPlayer.faction];
            if (factionInfo) {
                passivesContainer.innerHTML = `
                    <div><strong>Primary:</strong> ${factionInfo.passive}</div>
                    <div><strong>Secondary:</strong> ${factionInfo.secondary}</div>
                `;
            }
        }
    </script>
</body>
</html>
